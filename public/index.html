<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <title>Incext Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçë</text></svg>">

    <style>
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            /* TRICK 2: Use Dynamic Height (dvh) to respect the keyboard area */
            height: 100dvh; 
            overflow: hidden; /* Stop the whole page from scrolling */
        }

        /* The Main Container acts like a "Screen within a Screen" */
        #app-container {
            width: 100%;
            max-width: 500px; /* Limits width on laptops */
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- HEADER --- */
        header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            background: #fff;
            z-index: 10;
        }
        h1 { margin: 0; font-size: 1.2rem; color: #333; }
        #user-count { font-size: 0.8rem; color: #4CAF50; font-weight: bold; }

        /* --- CHAT AREA --- */
        #chat-box { 
            flex-grow: 1; /* Fills all available space */
            overflow-y: auto; /* Allows scrolling inside this box only */
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #f9f9f9;
            scroll-behavior: smooth;
        }

        /* Bubbles */
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; word-wrap: break-word; width: fit-content; font-size: 15px; }
        .my-msg { background: #007AFF; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .stranger-msg { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        .system-msg { align-self: center; color: #888; font-size: 0.8em; margin: 5px 0; text-align: center; }

        /* --- BOTTOM CONTROLS --- */
        #controls { 
            padding: 10px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex; /* Flex makes buttons sit nicely next to input */
            gap: 10px;
            align-items: center;
        }

        /* The input bar */
        input { 
            flex-grow: 1; /* Takes all remaining width */
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 25px; 
            outline: none;
            font-size: 16px; /* Prevents iPhone Zoom */
        }

        /* Buttons */
        button { border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        
        #sendBtn { 
            background-color: #007AFF; 
            padding: 12px 20px; 
            border-radius: 25px; 
        }
        
        #skipBtn { 
            background-color: #ff3b30; 
            padding: 12px; 
            border-radius: 50%; /* Circle button */
            width: 45px;
            height: 45px;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px;
        }

        /* --- START SCREEN OVERLAY --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        #findBtn {
            padding: 15px 40px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border-radius: 30px;
            margin-top: 20px;
        }

    </style>
</head>
<body>

    <div id="app-container">
        
        <header>
            <h1>Insext Anon Chat</h1>
            <span id="user-count">0 Online</span>
        </header>

        <div id="start-screen">
            <h2 style="color: #444;">Bored?</h2>
            <p style="color: #777;">Chat with a random cuck/bull.</p>
            <button id="findBtn">Find Friend</button>
            <p id="status" style="margin-top: 20px; color: #999; font-size: 14px;">Ready to search...</p>
        </div>

        <div id="chat-box"></div>

        <div id="controls" style="display: none;">
            <button id="skipBtn" title="Skip">‚ùå</button>
            <input type="text" id="msgInput" placeholder="Type a message...">
            <button id="sendBtn">Send</button>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null; 

        // Elements
        const startScreen = document.getElementById("start-screen");
        const findBtn = document.getElementById("findBtn");
        const statusText = document.getElementById("status");
        
        const chatBox = document.getElementById("chat-box");
        const controls = document.getElementById("controls");
        const msgInput = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");
        const skipBtn = document.getElementById("skipBtn");
        const userCount = document.getElementById("user-count");

        // --- SCROLL LOGIC ---
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- 1. FIND FRIEND ---
        findBtn.addEventListener("click", () => {
            startSearch();
        });

        // --- 2. SKIP ---
        skipBtn.addEventListener("click", () => {
            if(currentRoom) {
                socket.emit('leave-chat');
                addSystemMessage("You skipped.");
            }
            startSearch();
        });

        function startSearch() {
            currentRoom = null;
            chatBox.innerHTML = ""; 
            msgInput.value = "";
            
            // Show Loading UI
            findBtn.disabled = true;
            findBtn.innerText = "Searching...";
            findBtn.style.backgroundColor = "#ccc";
            statusText.innerText = "Looking for a partner...";
            
            socket.emit('join-chat');
        }

        // --- SOCKET EVENTS ---
        socket.on('user-count', (count) => {
            userCount.innerText = count + " Online";
        });

        socket.on('start-chat', (roomID) => {
            currentRoom = roomID;
            
            // Switch UI
            startScreen.style.display = "none";
            controls.style.display = "flex";
            
            addSystemMessage("Connected to Anonymous Friend.");
            
            msgInput.disabled = false;
            sendBtn.disabled = false;
            msgInput.focus();
        });

        socket.on('message', (msg) => {
            addMessage(msg, 'stranger-msg');
        });

        socket.on('stranger-disconnected', () => {
            addSystemMessage("Friend disconnected.");
            
            // Reset UI slightly
            msgInput.disabled = true;
            sendBtn.disabled = true;
            
            // Bring back start screen after 2 seconds? Or just offer "New" button?
            // Let's modify the SKIP button to be a "NEW" button
            skipBtn.innerHTML = "üîÑ"; // Refresh icon
            skipBtn.style.backgroundColor = "#4CAF50"; // Green
        });

        // --- MESSAGING ---
        sendBtn.addEventListener("click", sendMessage);
        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const msg = msgInput.value.trim();
            if(!msg) return;
            addMessage(msg, 'my-msg');
            socket.emit('user-message', { message: msg, room: currentRoom });
            msgInput.value = "";
            msgInput.focus();
        }

        function addMessage(msg, type) {
            const div = document.createElement('div');
            div.innerText = msg;
            div.classList.add('msg', type);
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function addSystemMessage(msg) {
            const div = document.createElement('div');
            div.innerText = msg;
            div.classList.add('msg', 'system-msg');
            chatBox.appendChild(div);
            scrollToBottom();
        }
    </script>
</body>
</html>