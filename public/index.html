<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Insext Chat</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 50px; 
            background-color: #f0f2f5;
        }

        h1 { margin-bottom: 5px; }
        p { color: #555; }

        /* The Main Chat Box */
        #chat-box { 
            width: 100%; 
            max-width: 400px; 
            height: 300px; 
            border: 1px solid #ccc; 
            overflow-y: scroll; 
            padding: 10px; 
            display: none; /* Hidden by default */
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Message Bubbles */
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 15px; width: fit-content; max-width: 80%; }
        .my-msg { background: #007AFF; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .stranger-msg { background: #e4e6eb; color: black; margin-right: auto; border-bottom-left-radius: 2px; }
        .system-msg { background: none; color: #888; font-size: 0.8em; margin: 10px auto; text-align: center; }

        /* Controls Area */
        #controls { 
            margin-top: 10px; 
            display: none; /* Hidden by default */
            width: 100%; 
            max-width: 400px; 
            gap: 10px; 
        }

        input { 
            flex-grow: 1; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 20px; 
            outline: none;
        }

        button { 
            padding: 10px 20px; 
            cursor: pointer; 
            border: none; 
            border-radius: 5px; 
            font-weight: bold; 
            color: white; 
        }

        /* Button Colors */
        #findBtn { width: 100%; max-width: 400px; background-color: #4CAF50; padding: 15px; font-size: 16px; border-radius: 8px; }
        #sendBtn { background-color: #007AFF; border-radius: 20px; }
        #skipBtn { background-color: #ff3b30; border-radius: 20px; }

        #status { font-weight: bold; margin-bottom: 10px; color: #555; }
    </style>
</head>
<body>

    <h1>Insext Anon Chat</h1>
    <p>Users Online: <span id="user-count">0</span></p>
    
    <p id="status">Click "Find Friend" to start</p>
    
    <button id="findBtn">Find Friend</button>

    <div id="chat-box"></div>

    <div id="controls">
        <button id="skipBtn">Skip</button>
        <input type="text" id="msgInput" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null; 

        // UI Elements
        const statusText = document.getElementById("status");
        const findBtn = document.getElementById("findBtn");
        const chatBox = document.getElementById("chat-box");
        const controls = document.getElementById("controls");
        const msgInput = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");
        const skipBtn = document.getElementById("skipBtn");
        const userCount = document.getElementById("user-count");

        // --- 1. FIND / START LOGIC ---
        findBtn.addEventListener("click", startSearch);
        
        // --- 2. SKIP LOGIC ---
        skipBtn.addEventListener("click", () => {
            if(currentRoom) {
                socket.emit('leave-chat');
                addSystemMessage("You skipped.");
            }
            startSearch(); // Immediately find next
        });

        function startSearch() {
            // Reset UI
            currentRoom = null;
            chatBox.innerHTML = ""; 
            
            // UI State: Searching
            findBtn.disabled = true;
            findBtn.innerText = "Searching...";
            findBtn.style.backgroundColor = "#ccc";
            statusText.innerText = "Looking for an anonymous friend...";
            
            // Hide controls while searching
            controls.style.display = "none";
            chatBox.style.display = "none";
            
            socket.emit('join-chat');
        }

        // --- SOCKET EVENTS ---
        socket.on('user-count', (count) => {
            userCount.innerText = count;
        });

        socket.on('start-chat', (roomID) => {
            currentRoom = roomID;
            
            // Show Chat UI
            chatBox.style.display = "block";
            controls.style.display = "flex";
            
            // Hide the big start button (we have skip now)
            findBtn.style.display = "none"; 

            statusText.innerText = "Anonymous Friend found! Say Hi.";
            
            
            msgInput.disabled = false;
            sendBtn.disabled = false;
            msgInput.focus();
        });

        socket.on('message', (msg) => {
            addMessage(msg, 'stranger-msg');
        });

        socket.on('stranger-disconnected', () => {
            statusText.innerText = "Anonymous Friend disconnected.";
            statusText.style.color = "red";
            
            msgInput.disabled = true;
            sendBtn.disabled = true;

            // Bring back the big button for "New Chat"
            findBtn.style.display = "block";
            findBtn.disabled = false;
            findBtn.innerText = "Find New Friend";
            findBtn.style.backgroundColor = "#4CAF50"; 
            
            controls.style.display = "none"; // Hide skip/input
        });

        // --- SEND MESSAGES ---
        sendBtn.addEventListener("click", sendMessage);
        msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const msg = msgInput.value.trim();
            if(!msg) return;
            addMessage(msg, 'my-msg');
            socket.emit('user-message', { message: msg, room: currentRoom });
            msgInput.value = "";
        }

        // --- HELPERS ---
        function addMessage(msg, type) {
            const div = document.createElement('div');
            div.innerText = msg;
            div.classList.add('msg', type);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; 
        }

        function addSystemMessage(msg) {
            const div = document.createElement('div');
            div.innerText = msg;
            div.classList.add('msg', 'system-msg');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; 
        }
    </script>
</body>
</html>